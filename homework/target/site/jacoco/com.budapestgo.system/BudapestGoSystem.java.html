<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BudapestGoSystem.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BudapestGO Ticket System - MBT</a> &gt; <a href="index.source.html" class="el_package">com.budapestgo.system</a> &gt; <span class="el_source">BudapestGoSystem.java</span></div><h1>BudapestGoSystem.java</h1><pre class="source lang-java linenums">package com.budapestgo.system;

import com.budapestgo.model.*;
import com.budapestgo.service.PaymentService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Main system class implementing the FSM for BudapestGO ticket purchase.
 * This class manages the state transitions and business logic.
 */
public class BudapestGoSystem {
<span class="fc" id="L13">    private static final Logger logger = LoggerFactory.getLogger(BudapestGoSystem.class);</span>
    private static final int MAX_RETRY_COUNT = 3;

    // Current FSM state
    private TicketState currentState;
    
    // State variables (EFSM)
    private TicketType selectedTicketType;
    private PaymentMethod selectedPaymentMethod;
    private String transactionId;
    private Ticket currentTicket;
    private int retryCount;
    
    // Services
    private final PaymentService paymentService;

    /**
     * Default constructor with default payment service.
     */
    public BudapestGoSystem() {
<span class="fc" id="L33">        this(new PaymentService());</span>
<span class="fc" id="L34">    }</span>

    /**
     * Constructor with custom payment service (useful for testing).
     *
     * @param paymentService Custom payment service instance
     */
<span class="fc" id="L41">    public BudapestGoSystem(PaymentService paymentService) {</span>
<span class="fc" id="L42">        this.paymentService = paymentService;</span>
<span class="fc" id="L43">        this.currentState = TicketState.IDLE;</span>
<span class="fc" id="L44">        this.retryCount = 0;</span>
<span class="fc" id="L45">        logger.info(&quot;BudapestGoSystem initialized in state: {}&quot;, currentState);</span>
<span class="fc" id="L46">    }</span>

    // ========== STATE TRANSITIONS ==========

    /**
     * Transition: IDLE -&gt; TICKET_SELECTED
     * User selects a ticket type.
     *
     * @param type The ticket type to select
     * @throws IllegalStateException if not in IDLE state
     * @throws IllegalArgumentException if type is null
     */
    public void selectTicketType(TicketType type) {
<span class="nc" id="L59">        logger.info(&quot;selectTicketType called with type: {}&quot;, type);</span>
        
<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (currentState != TicketState.IDLE) {</span>
<span class="nc" id="L62">            throw new IllegalStateException(</span>
<span class="nc" id="L63">                String.format(&quot;Cannot select ticket in state: %s. Expected: IDLE&quot;, currentState)</span>
            );
        }
        
<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (type == null) {</span>
<span class="nc" id="L68">            throw new IllegalArgumentException(&quot;Ticket type cannot be null&quot;);</span>
        }
        
<span class="nc" id="L71">        this.selectedTicketType = type;</span>
<span class="nc" id="L72">        this.currentState = TicketState.TICKET_SELECTED;</span>
        
<span class="nc" id="L74">        logger.info(&quot;Ticket type selected: {}. State changed to: {}&quot;, </span>
<span class="nc" id="L75">            type.getDisplayName(), currentState);</span>
<span class="nc" id="L76">    }</span>

    /**
     * Transition: TICKET_SELECTED -&gt; PAYMENT_METHOD_SELECTED
     * User chooses a payment method.
     *
     * @param method The payment method to use
     * @throws IllegalStateException if not in TICKET_SELECTED state or no ticket selected
     * @throws IllegalArgumentException if method is null
     */
    public void choosePaymentMethod(PaymentMethod method) {
<span class="nc" id="L87">        logger.info(&quot;choosePaymentMethod called with method: {}&quot;, method);</span>
        
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (currentState != TicketState.TICKET_SELECTED) {</span>
<span class="nc" id="L90">            throw new IllegalStateException(</span>
<span class="nc" id="L91">                String.format(&quot;Cannot choose payment in state: %s. Expected: TICKET_SELECTED&quot;, </span>
                    currentState)
            );
        }
        
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (selectedTicketType == null) {</span>
<span class="nc" id="L97">            throw new IllegalStateException(&quot;No ticket type selected&quot;);</span>
        }
        
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (method == null) {</span>
<span class="nc" id="L101">            throw new IllegalArgumentException(&quot;Payment method cannot be null&quot;);</span>
        }
        
<span class="nc" id="L104">        this.selectedPaymentMethod = method;</span>
<span class="nc" id="L105">        this.currentState = TicketState.PAYMENT_METHOD_SELECTED;</span>
        
<span class="nc" id="L107">        logger.info(&quot;Payment method selected: {}. State changed to: {}&quot;, </span>
<span class="nc" id="L108">            method.getDisplayName(), currentState);</span>
<span class="nc" id="L109">    }</span>

    /**
     * Transition: PAYMENT_METHOD_SELECTED -&gt; PAYMENT_PROCESSING -&gt; PAYMENT_SUCCESS/FAILED
     * Processes the payment transaction.
     *
     * @return true if payment successful, false otherwise
     * @throws IllegalStateException if not in PAYMENT_METHOD_SELECTED state
     */
    public boolean processPayment() {
<span class="nc" id="L119">        logger.info(&quot;processPayment called&quot;);</span>
        
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (currentState != TicketState.PAYMENT_METHOD_SELECTED) {</span>
<span class="nc" id="L122">            throw new IllegalStateException(</span>
<span class="nc" id="L123">                String.format(&quot;Cannot process payment in state: %s. Expected: PAYMENT_METHOD_SELECTED&quot;, </span>
                    currentState)
            );
        }
        
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (selectedPaymentMethod == null) {</span>
<span class="nc" id="L129">            throw new IllegalStateException(&quot;No payment method selected&quot;);</span>
        }
        
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (selectedTicketType == null) {</span>
<span class="nc" id="L133">            throw new IllegalStateException(&quot;No ticket type selected&quot;);</span>
        }
        
        // Transition to PAYMENT_PROCESSING
<span class="nc" id="L137">        this.currentState = TicketState.PAYMENT_PROCESSING;</span>
<span class="nc" id="L138">        logger.info(&quot;State changed to: {}&quot;, currentState);</span>
        
        // Process payment
<span class="nc" id="L141">        PaymentService.PaymentResult result = paymentService.processPayment(</span>
            selectedPaymentMethod,
<span class="nc" id="L143">            selectedTicketType.getPriceHUF()</span>
        );
        
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (result.isSuccess()) {</span>
            // Transition to PAYMENT_SUCCESS
<span class="nc" id="L148">            this.transactionId = result.getTransactionId();</span>
<span class="nc" id="L149">            this.currentState = TicketState.PAYMENT_SUCCESS;</span>
<span class="nc" id="L150">            this.retryCount = 0; // Reset retry counter on success</span>
            
<span class="nc" id="L152">            logger.info(&quot;Payment successful. Transaction ID: {}. State changed to: {}&quot;, </span>
                transactionId, currentState);
<span class="nc" id="L154">            return true;</span>
        } else {
            // Transition to PAYMENT_FAILED
<span class="nc" id="L157">            this.currentState = TicketState.PAYMENT_FAILED;</span>
            
<span class="nc" id="L159">            logger.warn(&quot;Payment failed: {}. State changed to: {}&quot;, </span>
<span class="nc" id="L160">                result.getMessage(), currentState);</span>
<span class="nc" id="L161">            return false;</span>
        }
    }

    /**
     * Transition: PAYMENT_METHOD_SELECTED -&gt; PAYMENT_PROCESSING
     * Initiates payment processing without completing it yet.
     *
     * @throws IllegalStateException if not in PAYMENT_METHOD_SELECTED state
     */
    public void initiatePaymentProcessing() {
<span class="nc" id="L172">        logger.info(&quot;initiatePaymentProcessing called&quot;);</span>
        
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (currentState != TicketState.PAYMENT_METHOD_SELECTED) {</span>
<span class="nc" id="L175">            throw new IllegalStateException(</span>
<span class="nc" id="L176">                String.format(&quot;Cannot initiate payment in state: %s. Expected: PAYMENT_METHOD_SELECTED&quot;, </span>
                    currentState)
            );
        }
        
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (selectedPaymentMethod == null) {</span>
<span class="nc" id="L182">            throw new IllegalStateException(&quot;No payment method selected&quot;);</span>
        }
        
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (selectedTicketType == null) {</span>
<span class="nc" id="L186">            throw new IllegalStateException(&quot;No ticket type selected&quot;);</span>
        }
        
        // Transition to PAYMENT_PROCESSING
<span class="nc" id="L190">        this.currentState = TicketState.PAYMENT_PROCESSING;</span>
<span class="nc" id="L191">        logger.info(&quot;State changed to: {}&quot;, currentState);</span>
<span class="nc" id="L192">    }</span>

    /**
     * Complete payment with success.
     * Transition: PAYMENT_PROCESSING -&gt; PAYMENT_SUCCESS
     *
     * @throws IllegalStateException if not in PAYMENT_PROCESSING state
     */
    public void completePaymentWithSuccess() {
<span class="nc" id="L201">        logger.info(&quot;completePaymentWithSuccess called&quot;);</span>
        
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (currentState != TicketState.PAYMENT_PROCESSING) {</span>
<span class="nc" id="L204">            throw new IllegalStateException(</span>
<span class="nc" id="L205">                String.format(&quot;Cannot complete payment in state: %s. Expected: PAYMENT_PROCESSING&quot;, </span>
                    currentState)
            );
        }
        
        // Process payment through service
<span class="nc" id="L211">        PaymentService.PaymentResult result = paymentService.processPayment(</span>
            selectedPaymentMethod,
<span class="nc" id="L213">            selectedTicketType.getPriceHUF()</span>
        );
        
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (result.isSuccess()) {</span>
<span class="nc" id="L217">            this.transactionId = result.getTransactionId();</span>
<span class="nc" id="L218">            this.currentState = TicketState.PAYMENT_SUCCESS;</span>
<span class="nc" id="L219">            this.retryCount = 0; // Reset retry counter on success</span>
            
<span class="nc" id="L221">            logger.info(&quot;Payment successful. Transaction ID: {}. State changed to: {}&quot;, </span>
                transactionId, currentState);
        } else {
<span class="nc" id="L224">            throw new RuntimeException(&quot;Payment service returned failure when expecting success: &quot; + </span>
<span class="nc" id="L225">                result.getMessage());</span>
        }
<span class="nc" id="L227">    }</span>

    /**
     * Complete payment with failure.
     * Transition: PAYMENT_PROCESSING -&gt; PAYMENT_FAILED
     *
     * @throws IllegalStateException if not in PAYMENT_PROCESSING state
     */
    public void completePaymentWithFailure() {
<span class="nc" id="L236">        logger.info(&quot;completePaymentWithFailure called&quot;);</span>
        
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (currentState != TicketState.PAYMENT_PROCESSING) {</span>
<span class="nc" id="L239">            throw new IllegalStateException(</span>
<span class="nc" id="L240">                String.format(&quot;Cannot fail payment in state: %s. Expected: PAYMENT_PROCESSING&quot;, </span>
                    currentState)
            );
        }
        
        // Transition to PAYMENT_FAILED
<span class="nc" id="L246">        this.currentState = TicketState.PAYMENT_FAILED;</span>
<span class="nc" id="L247">        this.retryCount++;</span>
        
<span class="nc" id="L249">        logger.warn(&quot;Payment failed. Retry count: {}. State changed to: {}&quot;, </span>
<span class="nc" id="L250">            retryCount, currentState);</span>
<span class="nc" id="L251">    }</span>

    /**
     * Transition: PAYMENT_FAILED -&gt; PAYMENT_METHOD_SELECTED (retry)
     * Allows user to retry payment after failure.
     *
     * @throws IllegalStateException if not in PAYMENT_FAILED state or max retries exceeded
     */
    public void retryPayment() {
<span class="nc" id="L260">        logger.info(&quot;retryPayment called (attempt {})&quot;, retryCount + 1);</span>
        
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (currentState != TicketState.PAYMENT_FAILED) {</span>
<span class="nc" id="L263">            throw new IllegalStateException(</span>
<span class="nc" id="L264">                String.format(&quot;Cannot retry payment in state: %s. Expected: PAYMENT_FAILED&quot;, </span>
                    currentState)
            );
        }
        
<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (retryCount &gt;= MAX_RETRY_COUNT) {</span>
<span class="nc" id="L270">            logger.error(&quot;Maximum retry attempts ({}) exceeded&quot;, MAX_RETRY_COUNT);</span>
            // Automatically reset system after max retries
<span class="nc" id="L272">            resetSystem();</span>
<span class="nc" id="L273">            throw new IllegalStateException(</span>
<span class="nc" id="L274">                String.format(&quot;Maximum retry attempts (%d) exceeded. Purchase cancelled.&quot;, </span>
<span class="nc" id="L275">                    MAX_RETRY_COUNT)</span>
            );
        }
        
<span class="nc" id="L279">        this.retryCount++;</span>
<span class="nc" id="L280">        this.currentState = TicketState.PAYMENT_METHOD_SELECTED;</span>
        
<span class="nc" id="L282">        logger.info(&quot;Retry count: {}. State changed to: {}&quot;, retryCount, currentState);</span>
<span class="nc" id="L283">    }</span>

    /**
     * Transition: PAYMENT_SUCCESS -&gt; QR_GENERATED
     * Generates QR code for the purchased ticket.
     *
     * @throws IllegalStateException if not in PAYMENT_SUCCESS state or no transaction ID
     */
    public void generateQRCode() {
<span class="nc" id="L292">        logger.info(&quot;generateQRCode called&quot;);</span>
        
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (currentState != TicketState.PAYMENT_SUCCESS) {</span>
<span class="nc" id="L295">            throw new IllegalStateException(</span>
<span class="nc" id="L296">                String.format(&quot;Cannot generate QR in state: %s. Expected: PAYMENT_SUCCESS&quot;, </span>
                    currentState)
            );
        }
        
<span class="nc bnc" id="L301" title="All 4 branches missed.">        if (transactionId == null || transactionId.trim().isEmpty()) {</span>
<span class="nc" id="L302">            throw new IllegalStateException(&quot;No transaction ID available&quot;);</span>
        }
        
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (selectedTicketType == null) {</span>
<span class="nc" id="L306">            throw new IllegalStateException(&quot;No ticket type selected&quot;);</span>
        }
        
        // Create ticket with QR code
<span class="nc" id="L310">        this.currentTicket = new Ticket(selectedTicketType, transactionId);</span>
<span class="nc" id="L311">        this.currentState = TicketState.QR_GENERATED;</span>
        
<span class="nc" id="L313">        logger.info(&quot;QR code generated: {}. State changed to: {}&quot;, </span>
<span class="nc" id="L314">            currentTicket.getQrCode(), currentState);</span>
<span class="nc" id="L315">    }</span>

    /**
     * Transition: QR_GENERATED -&gt; TICKET_ACTIVE
     * Validates (activates) the ticket.
     *
     * @throws IllegalStateException if not in QR_GENERATED state or no ticket available
     */
    public void validateTicket() {
<span class="nc" id="L324">        logger.info(&quot;validateTicket called&quot;);</span>
        
<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (currentState != TicketState.QR_GENERATED) {</span>
<span class="nc" id="L327">            throw new IllegalStateException(</span>
<span class="nc" id="L328">                String.format(&quot;Cannot validate ticket in state: %s. Expected: QR_GENERATED&quot;, </span>
                    currentState)
            );
        }
        
<span class="nc bnc" id="L333" title="All 2 branches missed.">        if (currentTicket == null) {</span>
<span class="nc" id="L334">            throw new IllegalStateException(&quot;No ticket available&quot;);</span>
        }
        
        // Validate the ticket
<span class="nc" id="L338">        currentTicket.validate();</span>
<span class="nc" id="L339">        this.currentState = TicketState.TICKET_ACTIVE;</span>
        
<span class="nc" id="L341">        logger.info(&quot;Ticket validated. Expires at: {}. State changed to: {}&quot;, </span>
<span class="nc" id="L342">            currentTicket.getExpiryTime(), currentState);</span>
<span class="nc" id="L343">    }</span>

    /**
     * Transition: TICKET_ACTIVE -&gt; TICKET_EXPIRED
     * Expires the active ticket.
     *
     * @throws IllegalStateException if not in TICKET_ACTIVE state or no active ticket
     */
    public void expireTicket() {
<span class="nc" id="L352">        logger.info(&quot;expireTicket called&quot;);</span>
        
<span class="nc bnc" id="L354" title="All 2 branches missed.">        if (currentState != TicketState.TICKET_ACTIVE) {</span>
<span class="nc" id="L355">            throw new IllegalStateException(</span>
<span class="nc" id="L356">                String.format(&quot;Cannot expire ticket in state: %s. Expected: TICKET_ACTIVE&quot;, </span>
                    currentState)
            );
        }
        
<span class="nc bnc" id="L361" title="All 4 branches missed.">        if (currentTicket == null || !currentTicket.isActive()) {</span>
<span class="nc" id="L362">            throw new IllegalStateException(&quot;No active ticket to expire&quot;);</span>
        }
        
        // Expire the ticket
<span class="nc" id="L366">        currentTicket.expire();</span>
<span class="nc" id="L367">        this.currentState = TicketState.TICKET_EXPIRED;</span>
        
<span class="nc" id="L369">        logger.info(&quot;Ticket expired. State changed to: {}&quot;, currentState);</span>
<span class="nc" id="L370">    }</span>

    /**
     * Transition: TICKET_SELECTED/PAYMENT_METHOD_SELECTED/PAYMENT_FAILED -&gt; IDLE
     * Cancels the purchase process.
     *
     * @throws IllegalStateException if cancellation not allowed in current state
     */
    public void cancelPurchase() {
<span class="nc" id="L379">        logger.info(&quot;cancelPurchase called from state: {}&quot;, currentState);</span>
        
<span class="nc bnc" id="L381" title="All 6 branches missed.">        if (currentState != TicketState.TICKET_SELECTED &amp;&amp;</span>
            currentState != TicketState.PAYMENT_METHOD_SELECTED &amp;&amp;
            currentState != TicketState.PAYMENT_FAILED) {
<span class="nc" id="L384">            throw new IllegalStateException(</span>
<span class="nc" id="L385">                String.format(&quot;Cannot cancel purchase in state: %s&quot;, currentState)</span>
            );
        }
        
<span class="nc" id="L389">        resetSystem();</span>
<span class="nc" id="L390">        logger.info(&quot;Purchase cancelled. System reset.&quot;);</span>
<span class="nc" id="L391">    }</span>

    /**
     * Transition: TICKET_EXPIRED -&gt; IDLE
     * Resets the system after ticket expiration.
     *
     * @throws IllegalStateException if not in TICKET_EXPIRED state
     */
    public void reset() {
<span class="nc" id="L400">        logger.info(&quot;reset called from state: {}&quot;, currentState);</span>
        
<span class="nc bnc" id="L402" title="All 2 branches missed.">        if (currentState != TicketState.TICKET_EXPIRED) {</span>
<span class="nc" id="L403">            throw new IllegalStateException(</span>
<span class="nc" id="L404">                String.format(&quot;Cannot reset in state: %s. Expected: TICKET_EXPIRED&quot;, </span>
                    currentState)
            );
        }
        
<span class="nc" id="L409">        resetSystem();</span>
<span class="nc" id="L410">        logger.info(&quot;System reset after ticket expiration.&quot;);</span>
<span class="nc" id="L411">    }</span>

    /**
     * Internal method to reset all system variables to initial state.
     */
    private void resetSystem() {
<span class="nc" id="L417">        this.selectedTicketType = null;</span>
<span class="nc" id="L418">        this.selectedPaymentMethod = null;</span>
<span class="nc" id="L419">        this.transactionId = null;</span>
<span class="nc" id="L420">        this.currentTicket = null;</span>
<span class="nc" id="L421">        this.retryCount = 0;</span>
<span class="nc" id="L422">        this.currentState = TicketState.IDLE;</span>
        
<span class="nc" id="L424">        logger.debug(&quot;System variables reset. State: {}&quot;, currentState);</span>
<span class="nc" id="L425">    }</span>

    // ========== GETTERS (for testing) ==========

    public TicketState getCurrentState() {
<span class="nc" id="L430">        return currentState;</span>
    }

    public TicketType getSelectedTicketType() {
<span class="nc" id="L434">        return selectedTicketType;</span>
    }

    public PaymentMethod getSelectedPaymentMethod() {
<span class="nc" id="L438">        return selectedPaymentMethod;</span>
    }

    public String getTransactionId() {
<span class="nc" id="L442">        return transactionId;</span>
    }

    public Ticket getCurrentTicket() {
<span class="nc" id="L446">        return currentTicket;</span>
    }

    public int getRetryCount() {
<span class="nc" id="L450">        return retryCount;</span>
    }

    /**
     * Checks if the system is in a specific state.
     *
     * @param state The state to check
     * @return true if system is in the specified state
     */
    public boolean isInState(TicketState state) {
<span class="nc bnc" id="L460" title="All 2 branches missed.">        return this.currentState == state;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L465">        return String.format(&quot;BudapestGoSystem{state=%s, ticketType=%s, paymentMethod=%s, &quot; +</span>
                &quot;transactionId='%s', hasTicket=%s, retryCount=%d}&quot;,
            currentState,
<span class="nc bnc" id="L468" title="All 2 branches missed.">            selectedTicketType != null ? selectedTicketType.getDisplayName() : &quot;null&quot;,</span>
<span class="nc bnc" id="L469" title="All 4 branches missed.">            selectedPaymentMethod != null ? selectedPaymentMethod.getDisplayName() : &quot;null&quot;,</span>
            transactionId,
<span class="nc" id="L471">            currentTicket != null,</span>
<span class="nc" id="L472">            retryCount</span>
        );
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>